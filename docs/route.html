<!DOCTYPE html>

<html>
<head>
  <title>new Route( router, path [, method] )</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page_wrapper">
            <div id="jump_page">
              
                
                <a class="source" href="helpers.html">
                  helpers.coffee
                </a>
              
                
                <a class="source" href="key.html">
                  key.coffee
                </a>
              
                
                <a class="source" href="resource.html">
                  resource.coffee
                </a>
              
                
                <a class="source" href="route.html">
                  route.coffee
                </a>
              
                
                <a class="source" href="router.html">
                  router.coffee
                </a>
              
                
                <a class="source" href="text.html">
                  text.coffee
                </a>
              
            </div>
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>{ Key, Glob }     = <span class="hljs-built_in">require</span> <span class="hljs-string">'./key'</span>
{ Text }          = <span class="hljs-built_in">require</span> <span class="hljs-string">'./text'</span>
{ Resource }      = <span class="hljs-built_in">require</span> <span class="hljs-string">'./resource'</span>
{ kindof, mixin } = <span class="hljs-built_in">require</span> <span class="hljs-string">'./helpers'</span>
inflection        = <span class="hljs-built_in">require</span> <span class="hljs-string">'inflection'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <h1 id="new-route-router-path-method-">new Route( router, path [, method] )</h1>

            </div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>turns strings into magical ponies that come when you call them</p>
<pre><code>route = <span class="hljs-keyword">new</span> Route(router, <span class="hljs-string">'/:controller/:action/:id(.:format)'</span>)
route = <span class="hljs-keyword">new</span> Route(router, <span class="hljs-string">'/:controller/:action(/:id)(.:format)'</span>, <span class="hljs-string">'GET'</span>)
route = <span class="hljs-keyword">new</span> Route(router, <span class="hljs-string">'/:controller/:action(/:id)(.:format)'</span>,
route = <span class="hljs-keyword">new</span> Route(router, <span class="hljs-string">'/:controller/:action/:id(.:format)'</span>, <span class="hljs-string">'GET'</span>)
</code></pre><p>Pretty familiar to anyone who’s used Merb/Rails - called by Router.match()</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>exports.Route =
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Route</span></span>
  <span class="hljs-attribute">constructor</span>: <span class="hljs-function"><span class="hljs-params">( router, path, method, <span class="hljs-property">@optional</span>=<span class="hljs-literal">false</span> )</span>-&gt;</span>
    <span class="hljs-keyword">if</span> router &amp;&amp; path
      <span class="hljs-property">@match</span>.apply <span class="hljs-keyword">this</span>, arguments</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <h2 id="route-match-">route.match()</h2>

            </div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>the actual route builder function, mostly called by <code>new Route</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">match</span>: <span class="hljs-function"><span class="hljs-params">( router, path, method, <span class="hljs-property">@optional</span>=<span class="hljs-literal">false</span> )</span>-&gt;</span>

    <span class="hljs-keyword">if</span> <span class="hljs-keyword">typeof</span> path != <span class="hljs-string">'string'</span>
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Error <span class="hljs-string">'path must be a string'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>is this a nested path?</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> <span class="hljs-property">@path</span>?
      prefix = <span class="hljs-property">@path</span></pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>get a list of key names in the new segment TODO: globs</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      new_keys = []
      new_keys.push <span class="hljs-string">':id'</span> <span class="hljs-keyword">if</span> <span class="hljs-property">@collection</span> || <span class="hljs-property">@member</span> <span class="hljs-comment"># force id to be renamed for resources</span>
      new_keys.push *path.match RegExp Key.regex.source, <span class="hljs-string">'g'</span> <span class="hljs-comment"># find ALL</span></pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>rename earlier keys</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">for</span> key <span class="hljs-keyword">in</span> new_keys
        replKey = <span class="hljs-keyword">new</span> RegExp <span class="hljs-string">":(<span class="hljs-subst">#{key.substring(<span class="hljs-number">1</span>)}</span>/?)"</span>
        prefix = prefix.replace replKey, <span class="hljs-string">":<span class="hljs-subst">#{inflection.underscore inflection.singularize <span class="hljs-property">@params</span>.controller}</span>_$1"</span></pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>create a new route instance</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      nested_route = <span class="hljs-keyword">new</span> Route router, prefix+path, method, <span class="hljs-property">@optional</span></pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>add local default params</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      nested_route.default_params = <span class="hljs-property">@default_params</span></pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>apply local conditions</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      nested_route.where <span class="hljs-property">@conditions</span> <span class="hljs-keyword">if</span> <span class="hljs-property">@conditions</span></pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>return the new awesomeness</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">return</span> nested_route</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>uppercase the method name</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">typeof</span>(method) == <span class="hljs-string">'string'</span>
      <span class="hljs-property">@method</span> = method.toUpperCase()</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>base properties</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-property">@params</span> = {}
    <span class="hljs-property">@default_params</span> = {}
    <span class="hljs-property">@parts</span> = []
    <span class="hljs-property">@route_name</span> = <span class="hljs-literal">null</span>
    <span class="hljs-property">@path</span> = path</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>@router = router</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    Object.defineProperty <span class="hljs-keyword">this</span>, <span class="hljs-string">'router'</span>, <span class="hljs-comment"># exclude in enumerables</span>
      <span class="hljs-attribute">enumerable</span>: <span class="hljs-literal">false</span>
      <span class="hljs-attribute">configurable</span>: <span class="hljs-literal">false</span>
      <span class="hljs-attribute">writable</span>: <span class="hljs-literal">false</span>
      <span class="hljs-attribute">value</span>: router

    <span class="hljs-property">@parts</span> = Route.parse router, path, method, <span class="hljs-property">@optional</span></pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>reset the path to the generated one (chop off any extra )’s )</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-property">@path</span> = <span class="hljs-property">@toString</span>()

    <span class="hljs-keyword">unless</span> <span class="hljs-property">@optional</span>
      <span class="hljs-property">@router</span>.routes.push <span class="hljs-keyword">this</span>

    <span class="hljs-keyword">this</span></pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <h2 id="convenience-methods">convenience methods</h2>

            </div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>
  <span class="hljs-attribute">get</span>: <span class="hljs-function"><span class="hljs-params">( path )</span>-&gt;</span>   <span class="hljs-property">@match</span> <span class="hljs-property">@router</span>, path, <span class="hljs-string">'GET'</span>
  <span class="hljs-attribute">put</span>: <span class="hljs-function"><span class="hljs-params">( path )</span>-&gt;</span>   <span class="hljs-property">@match</span> <span class="hljs-property">@router</span>, path, <span class="hljs-string">'PUT'</span>
  <span class="hljs-attribute">post</span>: <span class="hljs-function"><span class="hljs-params">( path )</span>-&gt;</span>  <span class="hljs-property">@match</span> <span class="hljs-property">@router</span>, path, <span class="hljs-string">'POST'</span>
  <span class="hljs-attribute">patch</span>: <span class="hljs-function"><span class="hljs-params">( path )</span>-&gt;</span> <span class="hljs-property">@match</span> <span class="hljs-property">@router</span>, path, <span class="hljs-string">'PATCH'</span>
  <span class="hljs-attribute">del</span>: <span class="hljs-function"><span class="hljs-params">( path )</span>-&gt;</span>   <span class="hljs-property">@match</span> <span class="hljs-property">@router</span>, path, <span class="hljs-string">'DELETE'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <h2 id="route-resource-controller-">route.resource( controller )</h2>

            </div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>generates standard resource routes for a controller name</p>
<pre><code>route.resource(<span class="hljs-string">'products'</span>)
</code></pre><p>returns a Resource object</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">resource</span>: <span class="hljs-function"><span class="hljs-params">( controller )</span>-&gt;</span>
    <span class="hljs-keyword">new</span> Resource <span class="hljs-keyword">this</span>, controller</pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <h2 id="route-regexstring-">route.regexString()</h2>

            </div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>returns a composite regex string of all route parts</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">regexString</span>: <span class="hljs-function">-&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p>a route regex is a composite of its parts’ regexe(s|n)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    ret = [<span class="hljs-string">'('</span>]
    ret.push part.regexString() <span class="hljs-keyword">for</span> part <span class="hljs-keyword">in</span> <span class="hljs-property">@parts</span>
    ret.push <span class="hljs-string">')'</span>
    ret.push <span class="hljs-string">'?'</span> <span class="hljs-keyword">if</span> <span class="hljs-property">@optional</span>
    ret.join <span class="hljs-string">''</span></pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <h2 id="route-test-string-">route.test( string )</h2>

            </div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <p>builds &amp; tests on a full regex of the entire path</p>
<pre><code>route.test( <span class="hljs-string">'/products/19/edit'</span> )
 =&gt; <span class="hljs-literal">true</span>
</code></pre><p>returns true/false depending on whether the url matches</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">test</span>: <span class="hljs-function"><span class="hljs-params">( string )</span>-&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <p>cache the regex string</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-property">@regex</span> ?= RegExp <span class="hljs-string">"^<span class="hljs-subst">#{<span class="hljs-property">@regexString</span>()}</span>(\\\?.*)?$"</span>

    <span class="hljs-property">@regex</span>.test string</pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <h2 id="route-to-endpoint-default_params-">route.to( endpoint [, default_params ] )</h2>

            </div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <p>defines the endpoint &amp; mixes in optional params</p>
<pre><code>route.to( <span class="hljs-string">'controller.action'</span> )

route.to( <span class="hljs-string">'controller.action'</span>, {<span class="hljs-attribute">lang</span>:<span class="hljs-string">'en'</span>} )
</code></pre><p>returns the route for chaining</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">to</span>: <span class="hljs-function"><span class="hljs-params">( endpoint, default_params )</span>-&gt;</span>

    <span class="hljs-keyword">if</span> !default_params &amp;&amp; <span class="hljs-keyword">typeof</span> endpoint != <span class="hljs-string">'string'</span>
      [ default_params, endpoint ] = [ endpoint, <span class="hljs-literal">undefined</span> ]

    mixin <span class="hljs-property">@default_params</span>, default_params</pre></div></div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              <p>TODO: make endpoint optional, since you can have the
controller &amp; action in the URL utself,
even though that’s a terrible idea…</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
    <span class="hljs-keyword">if</span> endpoint
      <span class="hljs-keyword">unless</span> <span class="hljs-number">0</span> &lt; endpoint.indexOf <span class="hljs-string">'.'</span>
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Error <span class="hljs-string">'syntax should be in the form: controller.action'</span>
      [ <span class="hljs-property">@params</span>.controller, <span class="hljs-property">@params</span>.action ] = endpoint.split <span class="hljs-string">'.'</span>

    mixin <span class="hljs-property">@params</span>, <span class="hljs-property">@default_params</span>

    <span class="hljs-keyword">this</span> <span class="hljs-comment"># chainable</span></pre></div></div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
              <h2 id="route-as-name-">route.as( name )</h2>

            </div>
            
        </li>
        
        
        <li id="section-31">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-31">&#182;</a>
              </div>
              <p>sets the route name - NAMED ROUTES ARE NOT CURRENTLY USED</p>
<pre><code>route.as( <span class="hljs-string">'login'</span> )
route.as( <span class="hljs-string">'homepage'</span> ) <span class="hljs-comment"># etc...</span>
</code></pre><p>returns: the route for chaining</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">as</span>: <span class="hljs-function"><span class="hljs-params">( <span class="hljs-property">@route_name</span> )</span>-&gt;</span>
    <span class="hljs-keyword">this</span> <span class="hljs-comment"># chainable</span></pre></div></div>
            
        </li>
        
        
        <li id="section-32">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-32">&#182;</a>
              </div>
              <p>alias for as</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">name</span>: <span class="hljs-function"><span class="hljs-params">( name )</span>-&gt;</span>
    <span class="hljs-built_in">console</span>.log <span class="hljs-string">'''
      DEPRECATION NOTICE: this method has been renamed "as"
      and will be removed in a future version of Barista
    '''</span>
    <span class="hljs-property">@as</span>.apply <span class="hljs-keyword">this</span>, arguments</pre></div></div>
            
        </li>
        
        
        <li id="section-33">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-33">&#182;</a>
              </div>
              <h2 id="route-where-conditions-">route.where( conditions )</h2>

            </div>
            
        </li>
        
        
        <li id="section-34">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-34">&#182;</a>
              </div>
              <p>sets conditions that each url variable must match for the URL to be valid</p>
<pre><code>route.where( { <span class="hljs-attribute">id</span>:<span class="hljs-regexp">/\d+/</span>, <span class="hljs-attribute">username</span>:<span class="hljs-regexp">/\w+/</span> } )
</code></pre><p>returns: the route for chaining</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">where</span>: <span class="hljs-function"><span class="hljs-params">( <span class="hljs-property">@conditions</span> )</span>-&gt;</span>
    <span class="hljs-keyword">if</span> kindof(<span class="hljs-property">@conditions</span>) != <span class="hljs-string">'object'</span>
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Error <span class="hljs-string">'conditions must be an object'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-35">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-35">&#182;</a>
              </div>
              <p>recursively apply all conditions to sub-parts</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    part.where? <span class="hljs-property">@conditions</span> <span class="hljs-keyword">for</span> part <span class="hljs-keyword">in</span> <span class="hljs-property">@parts</span>
    <span class="hljs-keyword">this</span> <span class="hljs-comment"># chainable</span></pre></div></div>
            
        </li>
        
        
        <li id="section-36">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-36">&#182;</a>
              </div>
              <h2 id="route-stringify-params-">route.stringify( params )</h2>

            </div>
            
        </li>
        
        
        <li id="section-37">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-37">&#182;</a>
              </div>
              <p>builds a string url for this Route from a params object</p>
<p>returns: [ “url”, [leftover params] ]</p>
<p><strong>this is meant to be called &amp; modified by router.url()</strong></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">stringify</span>: <span class="hljs-function"><span class="hljs-params">( params )</span>-&gt;</span>
    url = [] <span class="hljs-comment"># urls start life as an array to enable a second pass</span>
    <span class="hljs-keyword">for</span> part <span class="hljs-keyword">in</span> <span class="hljs-property">@parts</span>
      <span class="hljs-keyword">if</span> part <span class="hljs-keyword">instanceof</span> Key
        <span class="hljs-keyword">if</span> params[part.name]? &amp;&amp; part.regex.test params[part.name]</pre></div></div>
            
        </li>
        
        
        <li id="section-38">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-38">&#182;</a>
              </div>
              <p>there’s a param named this &amp;&amp; the param matches the key’s regex</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          url.push part.url params[part.name] <span class="hljs-comment"># push it onto the stack</span>
          <span class="hljs-keyword">delete</span> params[part.name]</pre></div></div>
            
        </li>
        
        
        <li id="section-39">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-39">&#182;</a>
              </div>
              <p><code>delete params[part.name]</code> # and remove from list of params</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> <span class="hljs-property">@optional</span></pre></div></div>
            
        </li>
        
        
        <li id="section-40">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-40">&#182;</a>
              </div>
              <p>(sub)route doesn’t match, move on</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
      <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> part <span class="hljs-keyword">instanceof</span> Route</pre></div></div>
            
        </li>
        
        
        <li id="section-41">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-41">&#182;</a>
              </div>
              <p>sub-routes must be handled in the next pass
to avoid leftover param duplication</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        url.push part
      <span class="hljs-keyword">else</span> <span class="hljs-comment"># string</span>
        url.push part</pre></div></div>
            
        </li>
        
        
        <li id="section-42">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-42">&#182;</a>
              </div>
              <p>second pass, resolve optional parts (backwards, so later optionals are resolved first)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">for</span> part, i <span class="hljs-keyword">in</span> url <span class="hljs-keyword">by</span> -<span class="hljs-number">1</span>
      <span class="hljs-keyword">if</span> part <span class="hljs-keyword">instanceof</span> Route
        part = part.stringify params <span class="hljs-comment"># recursion is your friend</span></pre></div></div>
            
        </li>
        
        
        <li id="section-43">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-43">&#182;</a>
              </div>
              <p>it resolved to a url fragment!</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> part
          params = part[<span class="hljs-number">1</span>] <span class="hljs-comment"># replace leftover params hash with the new, smaller leftover params hash</span>
          url[i] = part = part[<span class="hljs-number">0</span>] <span class="hljs-comment"># leave only the string for joining</span>
        <span class="hljs-keyword">else</span>
          <span class="hljs-keyword">delete</span> url[i] <span class="hljs-comment"># get rid of these shits</span>

    <span class="hljs-keyword">for</span> key, val <span class="hljs-keyword">of</span> <span class="hljs-property">@params</span></pre></div></div>
            
        </li>
        
        
        <li id="section-44">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-44">&#182;</a>
              </div>
              <p>remove from leftovers, they’re implied in the to() portion of the route</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">delete</span> params[key]

    [ url.join(<span class="hljs-string">''</span>), params ]</pre></div></div>
            
        </li>
        
        
        <li id="section-45">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-45">&#182;</a>
              </div>
              <h2 id="route-keysandroutes-">route.keysAndRoutes()</h2>

            </div>
            
        </li>
        
        
        <li id="section-46">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-46">&#182;</a>
              </div>
              <p>just the parts that aren’t strings. basically</p>
<p>returns an array of Key and Route objects</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">keysAndRoutes</span>: <span class="hljs-function">-&gt;</span>
    part <span class="hljs-keyword">for</span> part <span class="hljs-keyword">in</span> <span class="hljs-property">@parts</span> <span class="hljs-keyword">when</span> part <span class="hljs-keyword">instanceof</span> Key || part <span class="hljs-keyword">instanceof</span> Route</pre></div></div>
            
        </li>
        
        
        <li id="section-47">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-47">&#182;</a>
              </div>
              <h2 id="route-keys-">route.keys()</h2>

            </div>
            
        </li>
        
        
        <li id="section-48">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-48">&#182;</a>
              </div>
              <p>just the parts that are Keys (or globs)</p>
<p>returns an array of aforementioned Keys</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">keys</span>: <span class="hljs-function">-&gt;</span>
    part <span class="hljs-keyword">for</span> part <span class="hljs-keyword">in</span> <span class="hljs-property">@parts</span> <span class="hljs-keyword">when</span> part <span class="hljs-keyword">instanceof</span> Key</pre></div></div>
            
        </li>
        
        
        <li id="section-49">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-49">&#182;</a>
              </div>
              <h2 id="route-parse-url-method-">route.parse( url, method )</h2>

            </div>
            
        </li>
        
        
        <li id="section-50">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-50">&#182;</a>
              </div>
              <p>parses a URL into a params object</p>
<pre><code>route.parse( <span class="hljs-string">'/products/15/edit'</span>, <span class="hljs-string">'GET'</span> )
 =&gt; { <span class="hljs-attribute">controller</span>:<span class="hljs-string">'products'</span>, <span class="hljs-attribute">action</span>:<span class="hljs-string">'edit'</span>, <span class="hljs-attribute">id</span>:<span class="hljs-number">15</span> }
</code></pre><p>returns: a params hash || false (if the route doesn’t match)</p>
<p><strong>this is meant to be called by Router.first() &amp;&amp; Router.all()</strong></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">parse</span>: <span class="hljs-function"><span class="hljs-params">( urlParam, method )</span>-&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-51">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-51">&#182;</a>
              </div>
              <p>parse the URL with the regex &amp; step along with the parts,
assigning the vals from the url to the names of the keys as we go (potentially stoopid)</p>

            </div>
            
        </li>
        
        
        <li id="section-52">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-52">&#182;</a>
              </div>
              <p>let’s chop off the QS to make life easier</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    url =     <span class="hljs-built_in">require</span>(<span class="hljs-string">'url'</span>).parse urlParam <span class="hljs-comment"># TODO: fix this</span>
    path =    decodeURI url.pathname
    params =  <span class="hljs-attribute">method</span>: method

    mixin params, <span class="hljs-property">@params</span></pre></div></div>
            
        </li>
        
        
        <li id="section-53">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-53">&#182;</a>
              </div>
              <p>route HEAD requests to GET endpoints</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> is_head_req = params.method == <span class="hljs-string">'HEAD'</span>
      params.method = <span class="hljs-string">'GET'</span> <span class="hljs-comment"># we'll put it back when we're done</span></pre></div></div>
            
        </li>
        
        
        <li id="section-54">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-54">&#182;</a>
              </div>
              <p>if the method doesn’t match, gtfo immediately</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span> <span class="hljs-keyword">if</span> <span class="hljs-property">@method</span>? &amp;&amp; params.method? &amp;&amp; <span class="hljs-property">@method</span> != params.method</pre></div></div>
            
        </li>
        
        
        <li id="section-55">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-55">&#182;</a>
              </div>
              <p>assign the route’s method if there isn’t one</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    params.method ?= <span class="hljs-property">@method</span></pre></div></div>
            
        </li>
        
        
        <li id="section-56">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-56">&#182;</a>
              </div>
              <p>TODO: implement substring checks for possible performance boost</p>

            </div>
            
        </li>
        
        
        <li id="section-57">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-57">&#182;</a>
              </div>
              <p>if the route doesn’t match the regex, gtfo</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span> <span class="hljs-keyword">unless</span> <span class="hljs-property">@test</span> path</pre></div></div>
            
        </li>
        
        
        <li id="section-58">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-58">&#182;</a>
              </div>
              <p>parse the URL with the regex
first 2 elements are shit, chop ‘em</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    parts = <span class="hljs-keyword">new</span> RegExp(<span class="hljs-string">"^<span class="hljs-subst">#{<span class="hljs-property">@regexString</span>()}</span>$"</span>).exec(path)[<span class="hljs-number">2.</span>.]
    pairings = []</pre></div></div>
            
        </li>
        
        
        <li id="section-59">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-59">&#182;</a>
              </div>
              <p>loop 1 (forwards) - collect the key/route -&gt; part pairings for loop 2</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    j = <span class="hljs-number">0</span>
    <span class="hljs-keyword">for</span> segm <span class="hljs-keyword">in</span> <span class="hljs-property">@keysAndRoutes</span>()
      part = parts[j]</pre></div></div>
            
        </li>
        
        
        <li id="section-60">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-60">&#182;</a>
              </div>
              <p>stash the pairings for loop 2 if this part matches segment</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      pairings.push [ segm, part ] <span class="hljs-keyword">if</span> segm.test part</pre></div></div>
            
        </li>
        
        
        <li id="section-61">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-61">&#182;</a>
              </div>
              <p>routes must advance the part iterator by the number of parts matched in the segment</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      j+= segm.regex.exec(part||<span class="hljs-string">''</span>)[<span class="hljs-number">2.</span>.].length || <span class="hljs-number">1</span></pre></div></div>
            
        </li>
        
        
        <li id="section-62">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-62">&#182;</a>
              </div>
              <p>loop 2 (backwards) - parse the key/route -&gt; part pairings (backards so later optional matches are preferred)
i.e. /path(.:format)/something(.:format) would keep the last format segment, while discarding the first
this makes life easier for nesting route definitions</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">for</span> [ segm, part ] <span class="hljs-keyword">in</span> pairings <span class="hljs-keyword">by</span> -<span class="hljs-number">1</span></pre></div></div>
            
        </li>
        
        
        <li id="section-63">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-63">&#182;</a>
              </div>
              <p>actually mixin the params</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span> segm <span class="hljs-keyword">instanceof</span> Key
        params[segm.name] = part
      <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> segm <span class="hljs-keyword">instanceof</span> Route
        mixin params, segm.parse part, method</pre></div></div>
            
        </li>
        
        
        <li id="section-64">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-64">&#182;</a>
              </div>
              <p>replace HEAD method?</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    params.method = <span class="hljs-string">'HEAD'</span> <span class="hljs-keyword">if</span> is_head_req

    params



  <span class="hljs-attribute">nest</span>: <span class="hljs-function"><span class="hljs-params">( cb )</span>-&gt;</span>
    <span class="hljs-keyword">unless</span> <span class="hljs-keyword">typeof</span> cb == <span class="hljs-string">'function'</span>
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Error <span class="hljs-string">'route.nest() requires a callback function'</span>
    cb.call <span class="hljs-keyword">this</span>
    <span class="hljs-keyword">this</span> <span class="hljs-comment"># for chaining</span></pre></div></div>
            
        </li>
        
        
        <li id="section-65">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-65">&#182;</a>
              </div>
              <h2 id="route-tostring-">route.toString()</h2>

            </div>
            
        </li>
        
        
        <li id="section-66">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-66">&#182;</a>
              </div>
              <p>returns the original route definition</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">toString</span>: <span class="hljs-function">-&gt;</span>
    defn = (part.toString() <span class="hljs-keyword">for</span> part <span class="hljs-keyword">in</span> <span class="hljs-property">@parts</span>).join <span class="hljs-string">''</span>
    <span class="hljs-keyword">return</span> <span class="hljs-string">"(<span class="hljs-subst">#{ defn }</span>)"</span> <span class="hljs-keyword">if</span> <span class="hljs-property">@optional</span>
    defn</pre></div></div>
            
        </li>
        
        
        <li id="section-67">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-67">&#182;</a>
              </div>
              <h1 id="route-parse-router-string-method-optional-false-">Route.parse( router, string, method, optional=false )</h1>

            </div>
            
        </li>
        
        
        <li id="section-68">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-68">&#182;</a>
              </div>
              <p>parses a route definition into a swiss army bazooka</p>
<pre><code>route = Route.parse(router, <span class="hljs-string">'/:controller/:action/:id(.:format)'</span>)
route = Route.parse(router, <span class="hljs-string">'/:controller/:action(/:id)(.:format)'</span>, <span class="hljs-string">'GET'</span>)
route = Route.parse(router, <span class="hljs-string">'/:controller/:action(/:id)(.:format)'</span>,
route = Route.parse(router, <span class="hljs-string">'/:controller/:action/:id(.:format)'</span>, <span class="hljs-string">'GET'</span>)
</code></pre><p>Pretty familiar to anyone who’s used Merb/Rails - called by Router.match()</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
  <span class="hljs-property">@parse</span> = <span class="hljs-function"><span class="hljs-params">( router, string, method, optional=<span class="hljs-literal">false</span> )</span>-&gt;</span>
    parts = []</pre></div></div>
            
        </li>
        
        
        <li id="section-69">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-69">&#182;</a>
              </div>
              <p>parse it char by char, baby</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    i   = <span class="hljs-number">0</span>
    len = string.length</pre></div></div>
            
        </li>
        
        
        <li id="section-70">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-70">&#182;</a>
              </div>
              <p>for char, i in string</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">while</span> i &lt; len
      char = string[i]
      rest = string[i..]</pre></div></div>
            
        </li>
        
        
        <li id="section-71">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-71">&#182;</a>
              </div>
              <p>special consideration for Ogrp starts</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span> char == <span class="hljs-string">'('</span> &amp;&amp; i == <span class="hljs-number">0</span>
        i++
        <span class="hljs-keyword">continue</span> <span class="hljs-comment"># skip this char, since it's not strictly part of the route definition</span></pre></div></div>
            
        </li>
        
        
        <li id="section-72">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-72">&#182;</a>
              </div>
              <p>the route definition is over, return what we have</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span> char == <span class="hljs-string">')'</span>
        <span class="hljs-keyword">return</span> parts

      <span class="hljs-keyword">if</span> char == <span class="hljs-string">':'</span> &amp;&amp; string[i+<span class="hljs-number">1</span>] != <span class="hljs-string">':'</span>
        parts.push part = Key.parse rest
      <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> char == <span class="hljs-string">'*'</span>
        parts.push part = Glob.parse rest
      <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> char == <span class="hljs-string">'('</span>
        parts.push part = <span class="hljs-keyword">new</span> Route router, rest, method, <span class="hljs-literal">true</span>
      <span class="hljs-keyword">else</span>
        parts.push part = Text.parse rest

      i += part.toString().length

    parts</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
